#!/usr/bin/env bash

set -euo pipefail

{{ if eq .chezmoi.os "darwin" -}}
prefix="[install brew packages]"

if ! command -v brew >/dev/null 2>&1; then
  echo "$prefix Installing brew...."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
else
  echo "$prefix Brew is already installed."
fi

echo "$prefix ✅ Updating packages,,,"

brew update && \
brew bundle --file=/dev/stdin <<EOF
{{ range .packages.homebrew.taps -}}
tap {{ . | quote }}
{{ end -}}
{{ range .packages.homebrew.brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.homebrew.casks -}}
cask {{ . | quote }}
{{ end -}}
{{ range .packages.homebrew.vscodes -}}
vscode {{ . | quote }}
{{ end -}}
EOF

echo "$prefix ✅ Brew has finished sucessfully!"

{{ else if eq .chezmoi.os "linux" -}}
prefix="[install apt packages]"

# Check if we're on Ubuntu or Debian
if [ ! -f /etc/os-release ]; then
    echo "$prefix Cannot determine OS - /etc/os-release not found"
    exit 1
fi
. /etc/os-release

if [ "$ID" != "ubuntu" ] && [ "$ID" != "debian" ]; then
    echo "$prefix Not Ubuntu or Debian (detected: $ID) - skipping apt package installation"
    exit 0
fi

echo "$prefix Detected $NAME - installing apt packages..."
sudo apt update && sudo apt install -y \
{{- $len := len .packages.apt -}}
{{- range $i, $pkg := .packages.apt -}}
    {{ $pkg }}{{ if lt (add $i 1) $len }} \{{ end }}
{{ end -}}

echo "$prefix  ✅ Apt package installation complete!"

if command -v mise &>/dev/null; then
    echo "Installing mise..."
    curl -fsSL https://mise.run | bash
fi

if command -v az &>/dev/null; then
    curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
fi
{{ else }}

echo "Unable to determine package manager for {{ .chezmoi.os }}, skipping package installation..."

{{ end -}}
